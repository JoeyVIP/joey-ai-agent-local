# Joey's AI Agent 開發紀錄

## 專案資訊

- **專案名稱**: Joey's AI Agent（AI 自動化建站服務）
- **願景**: 素材進去，網站出來
- **目標**: LINE 傳任務 → AI 自動執行 → 部署上線 → 回傳網址
- **開始日期**: 2026-02-02

## 相關文件

- **完整架構計畫**: `~/.claude/plans/dapper-yawning-peacock.md`
- **業主報告**: `/docs/AI自動化建站服務-專案報告.md`

---

## 環境資訊

### 開發機 (MacBook)
- 本地開發測試用

### 部署機 (Mac mini)

**連線方式 1 - Tailscale (推薦)** ✅ 已測試
```bash
ssh macmini-remote
# 等同於：
ssh joeyserver@100.116.178.96 -i ~/.ssh/id_ed25519
```

**連線方式 2 - 公網域名**
```bash
ssh -p 2222 joeyliaomacmini@mini.89115053.xyz -i deploy_private_key
```

**環境狀態** (2025-02-02 確認)
- User: `joeyserver`
- Home: `/Users/joeyserver`
- 系統: macOS Darwin ARM64 (M1)
- ✅ Python 3.9.6 + pip 21.2.4
- ❌ Docker (未安裝)
- ❌ Homebrew (未安裝)
- ❌ cloudflared (未安裝)

**需要安裝**
```bash
# 安裝 Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安裝 cloudflared
brew install cloudflared

# (可選) 安裝 Docker
brew install --cask docker
```

---

## 開發進度

### 2026-02-03 - Ralph Wiggum 循環執行機制安裝

#### 完成項目

✅ **Ralph Wiggum 安裝**
- 安裝 [frankbria/ralph-claude-code](https://github.com/frankbria/ralph-claude-code)
- 安裝依賴：coreutils, jq, tmux
- 在 joey-ai-agent 專案啟用 Ralph
- 設定 PATH：`~/.local/bin`

✅ **Claude Code 更新**
- 從 1.0.103 更新到 2.1.29

✅ **重試機制實作**
- 新增 `execute_task_with_retry()` 方法
- 最多重試 3 次，每次最多 1 小時
- 自動分析錯誤並在重試時提供修正提示
- 偵測 `EXIT_SIGNAL: true` 或 `STATUS: COMPLETE` 作為成功標準

✅ **狀態回報格式**
```
---RALPH_STATUS---
STATUS: IN_PROGRESS | COMPLETE | BLOCKED
CURRENT_STEP: [目前步驟]
ITERATION: [迭代次數]
EXIT_SIGNAL: false | true
---END_RALPH_STATUS---
```

**Ralph 指令（Mac mini）**：
```bash
export PATH=$HOME/.local/bin:$PATH
ralph --help           # 查看說明
ralph --monitor        # 啟動監控模式
ralph-setup project    # 建立新專案
```

---

### 2026-02-03 - Playwright MCP 安裝 + 響應式設計優化

#### 完成項目

✅ **Playwright MCP 安裝**
- 發現 npx 不在 SSH PATH 中，需使用 `export PATH=/opt/homebrew/bin:$PATH`
- 安裝正確的套件：`@playwright/mcp`（非 `@anthropic-ai/mcp-playwright`）
- Chromium 瀏覽器已自動安裝到 `/Users/joeyserver/Library/Caches/ms-playwright/chromium-1208`
- MCP 連線狀態：✅ Connected

**Mac mini MCP Servers 現況：**
```
google-drive: npx -y @piotr-agier/google-drive-mcp - ✓ Connected
railway: npx -y @railway/mcp-server - ✓ Connected
playwright: npx -y @playwright/mcp - ✓ Connected
```

✅ **響應式設計規範強化**
- 更新 `claude_code_service.py` 自動化 Prompt
- 加入 Mobile-First 設計規範
- 加入詳細的 CSS 響應式斷點指引
- 加入桌面版 + 手機版雙重 Playwright 驗證流程
- 更新 `deploy-website.md` Skill 文件

**新增的驗證流程：**
1. 桌面版驗證（預設視窗）→ 截圖 desktop-home.png, desktop-footer.png
2. 手機版驗證（375x667 iPhone SE）→ 截圖 mobile-home.png, mobile-footer.png

**響應式設計禁止事項：**
- ❌ 固定寬度（如 width: 800px）
- ❌ 水平滾動條
- ❌ 文字小於 14px
- ❌ 按鈕小於 44x44px

✅ **程式碼同步**
```bash
rsync -avz --delete "/Users/JoeyLiao/Joey's AI Agent /joey-ai-agent/src/" macmini-remote:~/joey-ai-agent/src/
rsync -avz --delete "/Users/JoeyLiao/Joey's AI Agent /joey-ai-agent/skills/" macmini-remote:~/joey-ai-agent/skills/
```

---

### 2026-02-02 - 架構升級規劃完成

#### 新架構設計
- ✅ 兩階段執行流程（Claude API 分析 → Claude Code 執行）
- ✅ Ralph Wiggum 循環執行概念
- ✅ MCP 整合規劃（Google Drive、GitHub、Railway）
- ✅ 平行執行支援
- ✅ 進度追蹤功能設計
- ✅ Skills 系統設計
- ✅ 業主報告文件

#### 待實作
- [ ] Mac mini 安裝 Claude Code CLI
- [ ] MCP Servers 安裝與設定
- [ ] 程式碼更新（兩階段流程）
- [ ] Notion 資料庫欄位更新
- [ ] Skills 建立
- [ ] 端對端測試

---

### 2026-02-02 - Phase 1-5 完成（基礎版）

#### 完成項目

✅ **Phase 1: 專案設置**
- 建立專案目錄結構
- requirements.txt (FastAPI, uvicorn, line-bot-sdk, notion-client, anthropic, pydantic-settings)
- .env.example
- config.py (Pydantic Settings)

✅ **Phase 2: Notion 整合**
- notion_service.py
- Inbox CRUD (create, update status, delete)
- Review CRUD (simple + complex tasks)
- Memory 讀取/格式化/更新/建立
- setup_notion_databases.py 初始化腳本

✅ **Phase 3: Claude 整合**
- prompts/system_prompt.md
- models/claude_response.py (Pydantic models)
- claude_service.py
- JSON 解析和驗證

✅ **Phase 4: Line 整合**
- line_service.py (reply + push)
- api/line_webhook.py
- signature 驗證
- BackgroundTasks 非同步處理

✅ **Phase 5: 核心邏輯**
- task_processor.py
- 整合所有 services
- 錯誤處理和通知

✅ **Phase 6: 部署設定**
- Dockerfile
- docker-compose.yml
- README.md

#### 檔案結構
```
joey-ai-agent/
├── src/
│   ├── main.py                    # FastAPI 進入點
│   ├── config.py                  # Pydantic Settings
│   ├── api/
│   │   ├── health.py              # 健康檢查
│   │   └── line_webhook.py        # LINE Webhook
│   ├── services/
│   │   ├── line_service.py        # LINE 訊息處理
│   │   ├── notion_service.py      # Notion CRUD
│   │   ├── claude_service.py      # Claude API
│   │   └── task_processor.py      # 核心處理流程
│   ├── models/
│   │   └── claude_response.py     # Claude 回應結構
│   └── prompts/
│       └── system_prompt.md       # System Prompt
├── scripts/
│   ├── setup_notion_databases.py  # 初始化腳本
│   └── test_webhook.py            # 手動測試
├── .env.example
├── requirements.txt
├── Dockerfile
└── docker-compose.yml
```

---

## 待完成項目

### Phase 8: Web Frontend（已規劃）

**完整規劃文件**: `~/.claude/plans/dapper-yawning-peacock.md`

- [ ] 後端擴充（PostgreSQL + GitHub OAuth + SSE 進度）
- [ ] 前端建立（Next.js 14 + Tailwind + shadcn/ui）
- [ ] 真實進度監控（SSE 連線顯示 Agent 執行步驟）
- [ ] 部署（Render Web Service + Static Site）

### Phase 9: Cloudflare DNS 整合（規劃中）

- [ ] 支援自訂網域綁定
- [ ] 自動化 DNS 設定
- [ ] SSL 憑證自動配置

---

### Phase 7: 部署到 Mac mini

- [ ] SSH 到 Mac mini 部署程式碼
- [ ] 安裝 Homebrew 和 cloudflared
- [ ] 設定 Cloudflare Tunnel
- [ ] 設定 LaunchAgent 開機自動啟動
- [ ] 設定 LINE Webhook URL

#### 部署指令 (無 Docker 版)
```bash
# 1. 複製專案到 Mac mini
scp -r joey-ai-agent macmini-remote:~/

# 2. SSH 進入 Mac mini
ssh macmini-remote

# 3. 安裝依賴
cd ~/joey-ai-agent
pip3 install --user -r requirements.txt

# 4. 設定環境變數
cp .env.example .env
nano .env  # 填入所有 API keys

# 5. 測試啟動
python3 -m uvicorn src.main:app --host 0.0.0.0 --port 8000

# 6. 背景執行
nohup python3 -m uvicorn src.main:app --host 0.0.0.0 --port 8000 > ~/joey-ai-agent.log 2>&1 &
```

### 前置作業

- [x] 在 Notion 建立三個資料庫 (Inbox, Review, Memory) ✅ 2025-02-02
- [x] 分享資料庫給 Integration ✅ 自動完成
- [x] 取得所有 Database ID ✅ 見下方
- [x] 建立初始記憶 ✅ 2025-02-02
- [ ] 在 LINE Developers 建立 Messaging API Channel
- [ ] 取得 Channel Secret 和 Access Token

### Notion 資料庫 ID

```env
# 已移除敏感資訊 - 請查看 .env 檔案
NOTION_API_KEY=<redacted>
NOTION_INBOX_DB_ID=<redacted>
NOTION_REVIEW_DB_ID=<redacted>
NOTION_MEMORY_DB_ID=<redacted>
```

### Mac mini 環境設置

- [x] cloudflared 安裝 ✅ v2026.1.2 (~/bin/cloudflared)

---

## 設定指南

### Notion 設定

1. **建立 Integration**
   - 前往 https://www.notion.so/my-integrations
   - 建立「Joey AI Agent」
   - 複製 Token → `NOTION_API_KEY`

2. **建立 Inbox Database**
   - 欄位: Title, Status (received/processing), Source (line/manual), RawInput, ReceivedAt
   - 分享給 Integration
   - 複製 Database ID → `NOTION_INBOX_DB_ID`

3. **建立 Review Database**
   - 欄位: Title, Difficulty, Status, Summary, Result, Analysis, Preparation, PromptForClaudeCode, EstimatedTime, Reason, ProcessedAt, SourceTaskId
   - 分享給 Integration
   - 複製 Database ID → `NOTION_REVIEW_DB_ID`

4. **建立 Memory Database**
   - 欄位: Title, Category, Content, UpdatedAt, Importance
   - 分享給 Integration
   - 複製 Database ID → `NOTION_MEMORY_DB_ID`

### LINE 設定

1. 前往 https://developers.line.biz/console/
2. 建立 Messaging API Channel
3. Basic settings → Channel Secret → `LINE_CHANNEL_SECRET`
4. Messaging API → Issue token → `LINE_CHANNEL_ACCESS_TOKEN`
5. 部署後設定 Webhook URL: `https://your-domain/webhook/line`

### Cloudflare Tunnel 設定

```bash
# 安裝
brew install cloudflared

# 登入
cloudflared tunnel login

# 建立 tunnel
cloudflared tunnel create joey-ai-agent

# 設定 DNS
cloudflared tunnel route dns joey-ai-agent ai-agent.your-domain.com

# 建立 config
cat > ~/.cloudflared/config.yml << 'EOF'
tunnel: <TUNNEL_ID>
credentials-file: /Users/joeyserver/.cloudflared/<TUNNEL_ID>.json

ingress:
  - hostname: ai-agent.your-domain.com
    service: http://localhost:8000
  - service: http_status:404
EOF

# 啟動
cloudflared tunnel run joey-ai-agent
```

---

## 測試指令

```bash
# 本地啟動
cd joey-ai-agent
pip install -r requirements.txt
uvicorn src.main:app --reload

# 健康檢查
curl http://localhost:8000/health

# 模擬 webhook
python scripts/test_webhook.py "幫我想三個專案名稱"

# Docker 啟動
docker-compose up -d
```

---

## 問題紀錄

### 2026-02-03 - V3 太空貓咖啡館手機版問題

**問題**：手機版網站不友善，佈局有問題
**原因**：提示詞中缺乏明確的響應式設計規範
**解決**：
1. 更新 `claude_code_service.py` 加入 Mobile-First 設計規範
2. 加入具體的 CSS 斷點、Grid 響應式佈局範例
3. 加入 Playwright 手機版驗證流程（375x667）

### 2026-02-03 - Playwright MCP 安裝失敗

**問題**：`command not found: npx`
**原因**：SSH 連線不會載入完整 shell profile，Node.js 不在 PATH 中
**解決**：在指令前加上 `export PATH=/opt/homebrew/bin:$PATH`

**問題**：`@anthropic-ai/mcp-playwright` 套件不存在
**原因**：套件名稱錯誤
**解決**：正確套件是 `@playwright/mcp`

### 2026-02-02 - Railway Token 認證失敗

**問題**：Railway API 回傳 Unauthorized
**原因**：Railway API 已知 Bug
**解決**：改用 Render 部署

### 2026-02-03 - PATH 環境變數問題（V5 停止原因）

**問題**：V5 任務在 GitHub push 後停止，沒有部署到 Render
**原因**：Python 服務執行 Claude Code 時，PATH 只有 `/usr/bin:/bin`，缺少：
- `/opt/homebrew/bin`（npx, node, claude, gh）
- `~/.local/bin`（ralph）

**影響**：
- MCP servers 無法啟動（Playwright 驗證失敗）
- 部分 CLI 工具可能無法使用

**解決**：在 `claude_code_service.py` 中手動設定完整 PATH：
```python
homebrew_paths = "/opt/homebrew/bin:/opt/homebrew/sbin"
local_bin = f"/Users/{os.environ.get('USER', 'joeyserver')}/.local/bin"
env["PATH"] = f"{homebrew_paths}:{local_bin}:{current_path}"
```

---

### 2026-02-03 - 資料夾撇號問題

**問題**：文件被存到錯誤的資料夾
**原因**：資料夾名稱 `Joey's AI Agent` 含有撇號（apostrophe），容易造成路徑解析錯誤
**解決**：
1. 合併重複的 docs 資料夾
2. 刪除內層重複的 docs/docs/

**⚠️ 工作守則**：
- 存檔時務必確認路徑正確
- 路徑中有撇號時要特別小心
- 建議使用跳脫字元或引號包裹路徑：
  ```bash
  # 正確做法
  cd "/Users/JoeyLiao/Joey's AI Agent /"
  # 或
  cd /Users/JoeyLiao/Joey\'s\ AI\ Agent\ /
  ```

### 2026-02-02 - SSH 連線問題

**問題**：`ssh Joey-Mac-mini.local` 無法連線
**原因**：hostname 解析失敗
**解決**：使用 Tailscale 的 `macmini-remote` 別名（IP: 100.116.178.96）

---

## 參考資源

- [LINE Bot SDK Python](https://github.com/line/line-bot-sdk-python)
- [notion-sdk-py](https://github.com/ramnes/notion-sdk-py)
- [FastAPI Background Tasks](https://fastapi.tiangolo.com/tutorial/background-tasks/)
- [Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/)
